<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bazaario - Standalone User Management</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                },
            },
        }
    </script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- React & ReactDOM (Using cdnjs for better reliability) -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Jalaali JS -->
    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 2px solid #2d3748; }
        .light ::-webkit-scrollbar-track { background: #e5e7eb; }
        .light ::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
        
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }
        .modal-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        
        .spinner {
            border: 2px solid rgba(0,0,0,0.1);
            border-left-color: #4f46e5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        .dark .spinner {
            border: 2px solid rgba(255,255,255,0.1);
            border-left-color: #818cf8;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-100 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        // Access globals directly from window/library objects
        const { createClient } = window.supabase;
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const supabaseUrl = 'https://wehyjatotbzxargnxasg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        // ==================================================
        // Helper UI Components
        // ==================================================
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className={`modal-overlay ${isOpen ? 'open' : ''}`} onClick={onClose}>
                    <div className="modal-content bg-white dark:bg-gray-800 w-11/12 max-w-3xl rounded-xl shadow-2xl flex flex-col" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-5 border-b border-gray-100 dark:border-gray-700">
                            <h2 className="text-xl font-bold text-gray-800 dark:text-white">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-red-500 transition-colors w-8 h-8 flex items-center justify-center rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
                                <i className="fa-solid fa-times text-lg"></i>
                            </button>
                        </div>
                        <div className="p-5 overflow-y-auto custom-scrollbar">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title}>
                    <div className="text-center sm:text-right">
                        <div className="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4 sm:mx-0 sm:h-10 sm:w-10 sm:inline-flex sm:float-right sm:ml-4">
                            <i className="fa-solid fa-triangle-exclamation text-red-600 dark:text-red-400"></i>
                        </div>
                        <div className="mt-3 sm:mt-0 sm:mr-4 text-right">
                            <p className="text-sm text-gray-500 dark:text-gray-300">
                                {message}
                            </p>
                        </div>
                    </div>
                    <div className="mt-6 flex flex-col-reverse sm:flex-row gap-3 justify-end">
                        <button type="button" onClick={onClose} className="w-full sm:w-auto inline-flex justify-center rounded-lg border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none sm:text-sm">
                            لغو
                        </button>
                        <button type="button" onClick={onConfirm} className="w-full sm:w-auto inline-flex justify-center rounded-lg border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none sm:text-sm">
                            تایید و ادامه
                        </button>
                    </div>
                </Modal>
            );
        };
        
        const SearchableSelect = ({ options, value, onChange, placeholder, disabled = false }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [isOpen, setIsOpen] = useState(false);
            const wrapperRef = useRef(null);

            const selectedOption = useMemo(() => options.find(opt => opt.id === value), [options, value]);

            const filteredOptions = useMemo(() => {
                if (!searchTerm) return options;
                return options.filter(opt =>
                    opt.title.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [options, searchTerm]);

            useEffect(() => {
                function handleClickOutside(event) {
                    if (wrapperRef.current && !wrapperRef.current.contains(event.target)) {
                        setIsOpen(false);
                        setSearchTerm('');
                    }
                }
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const handleSelect = (option) => {
                onChange(option.id);
                setSearchTerm('');
                setIsOpen(false);
            };

            return (
                <div className="relative" ref={wrapperRef}>
                    <div className="relative">
                        <input
                            type="text"
                            placeholder={selectedOption ? selectedOption.title : placeholder}
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            onFocus={() => setIsOpen(true)}
                            disabled={disabled}
                            className={`w-full bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5 ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}
                        />
                        <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <i className={`fa-solid fa-chevron-down text-gray-400 transition-transform ${isOpen ? 'rotate-180' : ''}`}></i>
                        </div>
                    </div>
                    {isOpen && !disabled && (
                        <div className="absolute z-20 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <div
                                        key={option.id}
                                        onClick={() => handleSelect(option)}
                                        className="p-2.5 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 cursor-pointer text-sm transition-colors"
                                    >
                                        {option.title}
                                    </div>
                                ))
                            ) : (
                                <div className="p-2.5 text-gray-500 text-sm text-center">موردی یافت نشد</div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        const GenericManager = ({ onSave, title, tableName, items: initialItems, confirmModal, onManageAttributes, attributeLabel }) => {
            const [items, setItems] = useState(initialItems);
            const [newItemName, setNewItemName] = useState('');
            const [editingItem, setEditingItem] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                setItems(initialItems);
            }, [initialItems]);

            const handleAddItem = async (e) => {
                e.preventDefault();
                if (!newItemName.trim()) return;
                setIsLoading(true);
                setError('');

                const { data, error } = await supabaseClient.from(tableName).insert({ title: newItemName.trim() }).select().single();
                if (error) {
                    setError(`خطا در افزودن: ${error.message}`);
                } else {
                    setItems(prev => [...prev, data]);
                    setNewItemName('');
                    onSave();
                }
                setIsLoading(false);
            };

            const handleUpdateItem = async () => {
                if (!editingItem || !editingItem.title.trim()) return;
                setIsLoading(true);
                setError('');

                const { error } = await supabaseClient.from(tableName).update({ title: editingItem.title.trim() }).eq('id', editingItem.id);
                if (error) {
                    setError(`خطا در به‌روزرسانی: ${error.message}`);
                } else {
                    setItems(prev => prev.map(item => item.id === editingItem.id ? editingItem : item));
                    setEditingItem(null);
                    onSave();
                }
                setIsLoading(false);
            };

            const requestDeleteItem = (item) => {
                confirmModal({
                    isOpen: true,
                    message: `آیا از حذف "${item.title}" اطمینان دارید؟ این عمل ممکن است باعث خطا در موارد مرتبط شود.`,
                    onConfirm: () => executeDeleteItem(item.id)
                });
            };

            const executeDeleteItem = async (itemId) => {
                setIsLoading(true);
                setError('');
                const { error } = await supabaseClient.from(tableName).delete().eq('id', itemId);
                if (error) {
                    setError(`خطا در حذف. ممکن است این مورد استفاده شده باشد.`);
                } else {
                    setItems(prev => prev.filter(item => item.id !== itemId));
                    onSave();
                }
                setIsLoading(false);
            };
            
            return (
                <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm border border-gray-100 dark:border-gray-700">
                    <div className="flex items-center justify-between mb-4">
                        <h2 className="text-lg font-bold text-gray-800 dark:text-white flex items-center gap-2">
                           <i className={`fa-solid ${tableName === 'role' ? 'fa-user-shield' : 'fa-tags'} text-indigo-500`}></i>
                           {`لیست ${title}`}
                        </h2>
                        <span className="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded-full text-gray-500">{items.length} مورد</span>
                    </div>
                    
                    <form onSubmit={handleAddItem} className="flex gap-2 mb-4">
                        <input
                            type="text"
                            value={newItemName}
                            onChange={(e) => setNewItemName(e.target.value)}
                            placeholder={`افزودن ${title} جدید...`}
                            className="flex-grow bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
                        />
                        <button type="submit" disabled={isLoading} className="text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800 transition-colors">
                            {isLoading ? <div className="spinner w-4 h-4 border-white"></div> : <i className="fa-solid fa-plus"></i>}
                        </button>
                    </form>
                    
                    {error && <div className="p-3 mb-3 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-700 dark:text-red-400" role="alert">{error}</div>}
                    
                    <div className="max-h-80 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                        {items.map(item => (
                            <div key={item.id} className="group flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700/30 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                                {editingItem?.id === item.id ? (
                                    <div className="flex-grow flex gap-2 items-center">
                                        <input
                                            type="text"
                                            value={editingItem.title}
                                            onChange={(e) => setEditingItem({ ...editingItem, title: e.target.value })}
                                            className="flex-grow bg-white dark:bg-gray-600 border border-indigo-300 rounded p-1 text-sm"
                                            autoFocus
                                            onKeyDown={e => e.key === 'Enter' && handleUpdateItem()}
                                        />
                                        <button onClick={handleUpdateItem} className="text-green-600 hover:text-green-800"><i className="fa-solid fa-check"></i></button>
                                        <button onClick={() => setEditingItem(null)} className="text-red-500 hover:text-red-700"><i className="fa-solid fa-times"></i></button>
                                    </div>
                                ) : (
                                    <span className="text-sm font-medium text-gray-700 dark:text-gray-300">{item.title}</span>
                                )}
                                
                                {editingItem?.id !== item.id && (
                                    <div className="flex items-center gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                                        {onManageAttributes && (
                                            <button onClick={() => onManageAttributes(item)} className="text-xs text-teal-600 dark:text-teal-400 hover:underline flex items-center gap-1">
                                                <i className="fa-solid fa-list-check"></i> {attributeLabel}
                                            </button>
                                        )}
                                        <button onClick={() => setEditingItem(item)} className="text-indigo-500 hover:text-indigo-700 dark:text-indigo-400">
                                            <i className="fa-regular fa-pen-to-square"></i>
                                        </button>
                                        <button onClick={() => requestDeleteItem(item)} className="text-red-500 hover:text-red-700">
                                            <i className="fa-regular fa-trash-can"></i>
                                        </button>
                                    </div>
                                )}
                            </div>
                        ))}
                        {items.length === 0 && <p className="text-center text-gray-400 text-sm py-4">هیچ موردی یافت نشد.</p>}
                    </div>
                </div>
            );
        };
        
        // ==================================================
        // Address Form Components
        // ==================================================
        const AddressFormFields = ({ formData, setFormData, provinces, dynamicAttributes, attributeValues, onAttributeChange, shippingCompanies }) => {
            const [cities, setCities] = useState([]);
            const [isLoadingCities, setIsLoadingCities] = useState(false);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSelectChange = (name, value) => {
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            useEffect(() => {
                const fetchCities = async () => {
                    if (formData.provinceid) {
                        setIsLoadingCities(true);
                        const { data } = await supabaseClient.from('city').select('*').eq('provinceid', formData.provinceid).order('title');
                        setCities(data || []);
                        setIsLoadingCities(false);
                    } else {
                        setCities([]);
                    }
                };
                fetchCities();
            }, [formData.provinceid]);

            return (
                <div className="space-y-4 animate-fadeIn">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">استان</label>
                            <SearchableSelect
                                options={provinces}
                                value={formData.provinceid}
                                onChange={(id) => {
                                    handleSelectChange('provinceid', id);
                                    handleSelectChange('cityid', ''); // Reset city when province changes
                                }}
                                placeholder="جستجو یا انتخاب استان..."
                            />
                        </div>
                        <div>
                            <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white flex justify-between">
                                <span>شهر</span>
                                {isLoadingCities && <span className="text-xs text-indigo-500">در حال دریافت...</span>}
                            </label>
                            <SearchableSelect
                                options={cities}
                                value={formData.cityid}
                                onChange={(id) => handleSelectChange('cityid', id)}
                                placeholder={isLoadingCities ? 'در حال بارگذاری...' : "جستجو یا انتخاب شهر..."}
                                disabled={!formData.provinceid || isLoadingCities}
                            />
                        </div>
                   </div>
                    <div>
                        <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">آدرس کامل</label>
                        <textarea 
                            name="address" 
                            value={formData.address || ''} 
                            onChange={handleChange} 
                            rows="3" 
                            placeholder="خیابان، کوچه، و ..." 
                            className="block p-2.5 w-full text-sm text-gray-900 bg-white dark:bg-gray-700 rounded-lg border border-gray-300 dark:border-gray-600 focus:ring-indigo-500 focus:border-indigo-500"
                        ></textarea>
                   </div>
                   <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">شماره پلاک</label>
                            <input type="text" name="plaque" value={formData.plaque || ''} onChange={handleChange} className="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" />
                        </div>
                        <div>
                            <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">کد پستی</label>
                            <input type="text" name="postalcode" value={formData.postalcode || ''} onChange={handleChange} className="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" dir="ltr" className="text-right bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" />
                        </div>
                   </div>
                   <div>
                        <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">شرکت حمل و نقل ترجیحی</label>
                        <select name="preferredshippingcompanyid" value={formData.preferredshippingcompanyid || ''} onChange={handleChange} className="bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                            <option value="">انتخاب شرکت...</option>
                            {shippingCompanies.map(company => <option key={company.id} value={company.id}>{company.title}</option>)}
                        </select>
                    </div>
                   {dynamicAttributes && dynamicAttributes.length > 0 && (
                        <div className="bg-gray-50 dark:bg-gray-700/30 p-4 rounded-lg border border-gray-200 dark:border-gray-600 mt-4">
                            <h4 className="text-sm font-bold mb-3 text-gray-700 dark:text-gray-300 flex items-center gap-2">
                                <i className="fa-solid fa-circle-info text-indigo-500"></i>
                                اطلاعات تکمیلی آدرس
                            </h4>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {dynamicAttributes.map(attr => {
                                    let inputField;
                                    const commonClasses = "bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5";
                                    
                                    switch (attr.data_type) {
                                        case 'select':
                                            const options = Array.isArray(attr.options) ? attr.options : [];
                                            inputField = (
                                                <select
                                                    value={attributeValues[attr.id] || ''}
                                                    onChange={(e) => onAttributeChange(attr.id, e.target.value)}
                                                    className={commonClasses}
                                                >
                                                    <option value="">انتخاب کنید...</option>
                                                    {options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                </select>
                                            );
                                            break;
                                        case 'integer':
                                            inputField = (
                                                <input
                                                    type="number"
                                                    value={attributeValues[attr.id] || ''}
                                                    onChange={(e) => onAttributeChange(attr.id, e.target.value)}
                                                    className={commonClasses}
                                                />
                                            );
                                            break;
                                        default: // 'text'
                                            inputField = (
                                                <input
                                                    type="text"
                                                    value={attributeValues[attr.id] || ''}
                                                    onChange={(e) => onAttributeChange(attr.id, e.target.value)}
                                                    className={commonClasses}
                                                />
                                            );
                                    }
                                    return (
                                        <div key={attr.id}>
                                            <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{attr.title}</label>
                                            {inputField}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                   )}
                </div>
            )
        };
        
        const AddressForm = ({ user, roleId, address, onSave, onCancel, provinces, shippingCompanies, isNewUserFlow = false }) => {
            const initialAddress = {
                provinceid: '', cityid: '', address: '', postalcode: '', plaque: '', preferredshippingcompanyid: ''
            };
            const [addressData, setAddressData] = useState(initialAddress);
            const [dynamicAttributes, setDynamicAttributes] = useState([]);
            const [attributeValues, setAttributeValues] = useState({});
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState('');

            useEffect(() => {
                if (roleId) {
                    const fetchAttributes = async () => {
                        const { data, error } = await supabaseClient
                            .from('role_location_attribute')
                            .select('location_attribute_key(*)')
                            .eq('role_id', roleId);
                        
                        if (error) console.error("Error fetching role attributes:", error);
                        else setDynamicAttributes(data.map(item => item.location_attribute_key));
                    };
                    fetchAttributes();
                } else {
                    setDynamicAttributes([]);
                }
            }, [roleId]);

            useEffect(() => {
                if (address) { // Editing
                    setAddressData({
                        provinceid: address.provinceid || '',
                        cityid: address.cityid || '',
                        address: address.address || '',
                        postalcode: address.postalcode || '',
                        plaque: address.plaque || '',
                        preferredshippingcompanyid: address.preferredshippingcompanyid || ''
                    });

                    const fetchAttributeValues = async () => {
                        const { data, error } = await supabaseClient
                            .from('location_attribute_value')
                            .select('attribute_id, value')
                            .eq('location_id', address.id);
                        
                        if (error) console.error("Error fetching attribute values:", error);
                        else {
                            const values = data.reduce((acc, curr) => {
                                acc[curr.attribute_id] = curr.value;
                                return acc;
                            }, {});
                            setAttributeValues(values);
                        }
                    };
                    fetchAttributeValues();

                } else { // Adding new
                    setAddressData(initialAddress);
                    setAttributeValues({});
                }
            }, [address]);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                
                if (isNewUserFlow) {
                    onSave(addressData);
                    return;
                }

                setIsLoading(true);
                const locationFields = {
                    title: `آدرس ${user.fullname}`,
                    address: addressData.address,
                    postalcode: addressData.postalcode,
                    provinceid: addressData.provinceid || null,
                    cityid: addressData.cityid || null,
                    plaque: addressData.plaque || null,
                    preferredshippingcompanyid: addressData.preferredshippingcompanyid || null
                };

                try {
                    let locationId;
                    if (address) { // Update existing location
                        const { data, error } = await supabaseClient.from('location').update(locationFields).eq('id', address.id).select().single();
                        if (error) throw error;
                        locationId = data.id;
                    } else { // Insert new location and link it
                        if (!locationFields.address && !locationFields.cityid) {
                            onCancel(); 
                            return;
                        }
                        const { data: newLocation, error: insertError } = await supabaseClient.from('location').insert(locationFields).select().single();
                        if (insertError) throw insertError;
                        locationId = newLocation.id;
                        
                        const { error: linkError } = await supabaseClient.from('userlocation').insert({ userid: user.id, locationid: locationId });
                        if (linkError) throw linkError;
                    }

                    // Save dynamic attributes
                    if (locationId) {
                        await supabaseClient.from('location_attribute_value').delete().eq('location_id', locationId);

                        const valuesToInsert = Object.entries(attributeValues)
                            .filter(([key, value]) => value)
                            .map(([key, value]) => ({
                                location_id: locationId,
                                attribute_id: parseInt(key),
                                value: value
                            }));
                        
                        if (valuesToInsert.length > 0) {
                            const { error: attrError } = await supabaseClient.from('location_attribute_value').insert(valuesToInsert);
                            if (attrError) throw attrError;
                        }
                    }
                    onSave();
                } catch (err) {
                    console.error("Address save error:", err);
                    setError(err.message || "خطا در ذخیره آدرس.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <form onSubmit={handleSubmit} className="bg-gray-50 dark:bg-gray-700/20 p-4 rounded-lg border border-gray-200 dark:border-gray-700 mt-4 animate-fadeIn">
                    <div className="flex justify-between items-center mb-4 pb-2 border-b border-gray-200 dark:border-gray-600">
                        <h4 className="text-md font-bold text-indigo-600 dark:text-indigo-400">
                            {address ? `ویرایش آدرس (شناسه: ${address.id})` : 'افزودن آدرس جدید'}
                        </h4>
                        <button type="button" onClick={onCancel} className="text-gray-500 hover:text-gray-700"><i className="fa-solid fa-times"></i></button>
                    </div>
                    <AddressFormFields 
                        formData={addressData} 
                        setFormData={setAddressData} 
                        provinces={provinces}
                        shippingCompanies={shippingCompanies}
                        dynamicAttributes={dynamicAttributes}
                        attributeValues={attributeValues}
                        onAttributeChange={(id, value) => setAttributeValues(prev => ({...prev, [id]: value}))}
                    />
                    {error && <p className="text-red-500 text-sm mt-2"><i className="fa-solid fa-triangle-exclamation"></i> {error}</p>}
                    <div className="flex justify-end gap-3 pt-4 mt-2">
                        <button type="button" onClick={onCancel} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">
                            انصراف
                        </button>
                        <button type="submit" disabled={isLoading} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-900 flex items-center gap-2">
                            {isLoading && <div className="spinner w-4 h-4 border-white"></div>}
                            ذخیره آدرس
                        </button>
                    </div>
                </form>
            );
        };
        
        // ==================================================
        // User Form & Management Components
        // ==================================================
        const UserForm = ({ isOpen, onClose, onSave, user, appData }) => {
            const { roles, provinces, marketingChannels, shippingCompanies } = appData;
            const initialFormData = {
                fullname: '', firstname: '', email: '', mobile: '', emergencyphonenumber: '', roleid: '', marketingchannelid: '', prefix: ''
            };
            const [formData, setFormData] = useState(initialFormData);
            const [isChecking, setIsChecking] = useState(false);
            const [existingUser, setExistingUser] = useState(null);
            const [error, setError] = useState('');
            const customerRoleId = useMemo(() => roles.find(r => r.title === 'Customer')?.id, [roles]);
            
            const [showAddressForm, setShowAddressForm] = useState(false);
            const [editingAddress, setEditingAddress] = useState(null);
            const [userLocations, setUserLocations] = useState([]);
            const [newAddresses, setNewAddresses] = useState([]);

            const fetchUserLocations = async (userId) => {
                if (!userId) return;
                const { data, error } = await supabaseClient
                    .from('userlocation')
                    .select('*, location(*, city(*, province(*)))')
                    .eq('userid', userId);
                if (error) console.error("Error fetching user locations:", error);
                else setUserLocations(data || []);
            };

            useEffect(() => {
                if (isOpen) {
                    setError('');
                    setShowAddressForm(false);
                    setEditingAddress(null);
                    setNewAddresses([]);

                    if (user) {
                        setFormData({
                            ...initialFormData,
                            fullname: user.fullname || '',
                            firstname: user.firstname || '',
                            prefix: user.prefix || '',
                            email: user.email?.endsWith('@placeholder.email') ? '' : user.email || '',
                            mobile: user.mobile || '',
                            emergencyphonenumber: user.emergencyphonenumber || '',
                            roleid: user.role?.id || '',
                            marketingchannelid: user.marketingchannelid || '',
                        });
                        setExistingUser(user);
                        fetchUserLocations(user.id);
                    } else {
                        setFormData({ ...initialFormData, roleid: customerRoleId || '' });
                        setExistingUser(null);
                        setUserLocations([]);
                    }
                }
            }, [user, isOpen, customerRoleId]);

            const handleMobileChange = async (e) => {
                const mobile = e.target.value;
                setFormData(prev => ({ ...prev, mobile }));
                setError('');

                if (mobile && mobile.length >= 10) { 
                    setIsChecking(true);
                    const { data } = await supabaseClient.from('profiles').select('*, role(id, title)').eq('mobile', mobile).single();
                    if (data) {
                        setFormData(prev => ({
                            ...prev,
                            fullname: data.fullname || '',
                            firstname: data.firstname || '',
                            prefix: data.prefix || '',
                            email: data.email?.endsWith('@placeholder.email') ? '' : data.email || '',
                            emergencyphonenumber: data.emergencyphonenumber || '',
                            roleid: data.role?.id || customerRoleId,
                            marketingchannelid: data.marketingchannelid || '',
                        }));
                        setExistingUser(data);
                        fetchUserLocations(data.id);
                        setShowAddressForm(false);
                    } else {
                        setFormData(prev => ({ ...initialFormData, mobile: prev.mobile, roleid: customerRoleId || '' }));
                        setExistingUser(null);
                        setUserLocations([]);
                        setShowAddressForm(false);
                    }
                    setIsChecking(false);
                } else {
                    setExistingUser(null);
                    setUserLocations([]);
                }
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                if (!formData.mobile) {
                    setError('شماره موبایل اجباری است.');
                    return;
                }

                try {
                    const profileData = {
                        fullname: formData.fullname,
                        firstname: formData.firstname || null,
                        prefix: formData.prefix || null,
                        email: formData.email || `${formData.mobile}@placeholder.email`,
                        emergencyphonenumber: formData.emergencyphonenumber || null,
                        roleid: formData.roleid,
                        marketingchannelid: formData.marketingchannelid || null,
                    };

                    if (existingUser) { // UPDATE USER
                        const { error: profileError } = await supabaseClient
                            .from('profiles')
                            .update(profileData)
                            .eq('id', existingUser.id);
                        if (profileError) throw profileError;
                        onSave();
                        onClose();

                    } else { // CREATE NEW USER
                        const password = formData.mobile.slice(-6);
                        if (password.length < 6) throw new Error('شماره موبایل باید معتبر باشد.');
                        
                        const { data: authData, error: authError } = await supabaseClient.auth.signUp({ email: profileData.email, password });
                        if (authError) throw new Error(authError.message.includes("User already registered") ? "کاربری با این ایمیل یا شماره موبایل قبلا ثبت‌نام کرده است." : "خطا در ایجاد کاربر.");
                        
                        if (authData.user) {
                            const { error: profileError } = await supabaseClient
                                .from('profiles')
                                .update({ ...profileData, mobile: formData.mobile })
                                .eq('id', authData.user.id);
                            if (profileError) throw profileError;
                            
                            for (const addr of newAddresses) {
                                const locationFields = {
                                    title: `آدرس ${formData.fullname}`,
                                    address: addr.address,
                                    postalcode: addr.postalcode,
                                    provinceid: addr.provinceid || null,
                                    cityid: addr.cityid || null,
                                    plaque: addr.plaque || null,
                                    preferredshippingcompanyid: addr.preferredshippingcompanyid || null
                                };
                                const { data: locationData, error: locationError } = await supabaseClient.from('location').insert(locationFields).select().single();
                                if (locationError) throw new Error('خطا در ذخیره آدرس.');
                                if (locationData) {
                                    const { error: userLocationError } = await supabaseClient.from('userlocation').insert({ userid: authData.user.id, locationid: locationData.id });
                                    if (userLocationError) throw new Error('خطا در اتصال آدرس به کاربر.');
                                }
                            }
                            onSave();
                            onClose();
                        }
                    }
                } catch (err) {
                    console.error("Submit error:", err);
                    setError(err.message || "یک خطای ناشناخته رخ داد.");
                }
            };

            const handleAddressSaved = () => {
                setShowAddressForm(false);
                setEditingAddress(null);
                fetchUserLocations(existingUser.id);
                onSave();
            };

            const handleDeleteAddress = async (locationId) => {
                const { error: linkError } = await supabaseClient.from('userlocation').delete().eq('locationid', locationId).eq('userid', existingUser.id);
                if (linkError) {
                    setError("خطا در حذف اتصال آدرس به کاربر.");
                    console.error(linkError);
                    return;
                }

                const { error: locationError } = await supabaseClient.from('location').delete().eq('id', locationId);
                if (locationError) {
                    setError("خطا در حذف آدرس.");
                    console.error(locationError);
                    return;
                }

                fetchUserLocations(existingUser.id);
                onSave();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={user ? 'ویرایش کاربر' : 'افزودن کاربر جدید'}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* Left Column */}
                            <div className="space-y-4">
                                <div>
                                    <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">شماره موبایل</label>
                                    <div className="relative">
                                        <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                            <i className="fa-solid fa-mobile-screen text-gray-400"></i>
                                        </div>
                                        <input type="tel" name="mobile" value={formData.mobile} onChange={handleMobileChange} placeholder="09..." className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 p-2.5" required disabled={!!user} />
                                        {isChecking && <div className="spinner absolute left-10 top-1/2 -translate-y-1/2 w-4 h-4"></div>}
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <div className="w-1/4">
                                        <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">عنوان</label>
                                        <select name="prefix" value={formData.prefix} onChange={handleChange} className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                            <option value="">انتخاب...</option>
                                            <option value="Mr">جناب</option>
                                            <option value="Mrs">بانو</option>
                                            <option value="Company">شرکت</option>
                                        </select>
                                    </div>
                                    <div className="w-1/3">
                                        <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">نام کوچک</label>
                                        <input type="text" name="firstname" value={formData.firstname} onChange={handleChange} placeholder="نام کوچک" className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" />
                                    </div>
                                    <div className="flex-grow">
                                        <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">نام کامل</label>
                                        <input type="text" name="fullname" value={formData.fullname} onChange={handleChange} placeholder="نام کامل" className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" required />
                                    </div>
                                </div>
                                <div>
                                    <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">ایمیل (اختیاری)</label>
                                    <input type="email" name="email" value={formData.email} onChange={handleChange} placeholder="example@mail.com" className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" />
                                </div>
                            </div>
                            
                            {/* Right Column */}
                            <div className="space-y-4">
                                 <div>
                                    <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">شماره موبایل دوم</label>
                                    <input type="tel" name="emergencyphonenumber" value={formData.emergencyphonenumber} onChange={handleChange} placeholder="شماره تماس اضطراری" className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" />
                                </div>
                                <div>
                                    <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">نقش</label>
                                    <select name="roleid" value={formData.roleid} onChange={handleChange} className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5" required>
                                        {roles.map(role => <option key={role.id} value={role.id}>{role.title}</option>)}
                                    </select>
                                </div>
                                <div>
                                    <label className="block mb-2 text-sm font-medium text-gray-900 dark:text-white">کانال جذب</label>
                                    <select name="marketingchannelid" value={formData.marketingchannelid} onChange={handleChange} className="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2.5">
                                        <option value="">انتخاب کانال...</option>
                                        {marketingChannels.map(channel => <option key={channel.id} value={channel.id}>{channel.title}</option>)}
                                    </select>
                                </div>
                            </div>
                        </div>

                         {error && <div className="p-3 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-red-900/20 dark:text-red-400" role="alert">{error}</div>}
                         {existingUser && !user && <div className="p-3 text-sm text-green-800 rounded-lg bg-green-50 dark:bg-green-900/20 dark:text-green-400">کاربر یافت شد. اطلاعات فرم به‌روزرسانی خواهد شد.</div>}
                         {!existingUser && formData.mobile.length >= 10 && !isChecking && <div className="p-3 text-sm text-blue-800 rounded-lg bg-blue-50 dark:bg-blue-900/20 dark:text-blue-400">کاربر جدید. رمز عبور پیش‌فرض: ۶ رقم آخر موبایل.</div>}
                        
                        <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4">
                            <button type="submit" disabled={isChecking} className="w-full sm:w-auto text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:outline-none focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-indigo-600 dark:hover:bg-indigo-700 dark:focus:ring-indigo-800 transition-all">
                                {existingUser ? 'به‌روزرسانی اطلاعات' : 'ایجاد کاربر'}
                            </button>
                        </div>
                    </form>

                    {/* Address Management Section */}
                    <div className="mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-semibold text-gray-800 dark:text-gray-200 flex items-center gap-2">
                                <i className="fa-solid fa-map-location-dot text-indigo-500"></i>
                                مدیریت آدرس‌ها
                            </h3>
                            {!showAddressForm && (
                                <button type="button" onClick={() => { setEditingAddress(null); setShowAddressForm(true); }} className="text-xs font-medium text-white bg-green-500 hover:bg-green-600 px-3 py-1.5 rounded-lg transition-colors">
                                    <i className="fa-solid fa-plus ml-1"></i> افزودن آدرس
                                </button>
                            )}
                        </div>
                        
                        {existingUser && userLocations.length > 0 && !showAddressForm && (
                            <div className="grid grid-cols-1 gap-3">
                                {userLocations.map(({ location }) => {
                                    const fullAddress = `${location.city?.province?.title || ''}، ${location.city?.title || ''}، ${location.address || ''}`;
                                    return (
                                        <div key={location.id} className="p-3 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2">
                                            <div className="flex items-start gap-3">
                                                <div className="mt-1 text-gray-400"><i className="fa-solid fa-location-dot"></i></div>
                                                <div>
                                                    <p className="text-sm font-medium text-gray-800 dark:text-gray-200">{fullAddress}</p>
                                                    <p className="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                        شناسه: {location.id} | پلاک: {location.plaque || '-'} | کدپستی: {location.postalcode || '-'}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="flex gap-2 self-end sm:self-center">
                                                <button onClick={() => { setEditingAddress(location); setShowAddressForm(true); }} className="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/30 p-1.5 rounded-md transition-colors">
                                                    <i className="fa-regular fa-pen-to-square"></i>
                                                </button>
                                                <button onClick={() => handleDeleteAddress(location.id)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/30 p-1.5 rounded-md transition-colors">
                                                    <i className="fa-regular fa-trash-can"></i>
                                                </button>
                                            </div>
                                        </div>
                                    )
                                })}
                            </div>
                        )}

                        {!existingUser && newAddresses.length > 0 && !showAddressForm && (
                             <div className="grid grid-cols-1 gap-3">
                                {newAddresses.map((addr, index) => {
                                    const provinceName = provinces.find(p => p.id === addr.provinceid)?.title || '';
                                    const cityName = appData.cities?.find(c => c.id === addr.cityid)?.title || ''; // Note: city might not resolve if appData.cities not populated globally, simplified logic
                                    const fullAddress = `${provinceName}، ${addr.address || ''}`;
                                    return (
                                        <div key={index} className="p-3 bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-100 dark:border-indigo-800 rounded-lg flex justify-between items-center">
                                            <div className="flex items-center gap-2">
                                                <span className="bg-indigo-200 text-indigo-800 text-xs px-2 py-0.5 rounded">جدید</span>
                                                <p className="text-sm text-gray-700 dark:text-gray-300 truncate">{fullAddress}</p>
                                            </div>
                                            <button onClick={() => setNewAddresses(prev => prev.filter((_, i) => i !== index))} className="text-red-500 hover:text-red-700 p-1">
                                                <i className="fa-solid fa-times"></i>
                                            </button>
                                        </div>
                                    )
                                })}
                            </div>
                        )}
                        
                        {!showAddressForm && userLocations.length === 0 && newAddresses.length === 0 && (
                            <div className="text-center py-6 bg-gray-50 dark:bg-gray-700/30 rounded-lg border border-dashed border-gray-300 dark:border-gray-600">
                                <p className="text-gray-500 dark:text-gray-400 text-sm">هنوز آدرسی ثبت نشده است</p>
                            </div>
                        )}

                        {showAddressForm && (
                            <AddressForm 
                                user={existingUser || { fullname: formData.fullname, id: null }}
                                roleId={formData.roleid}
                                address={editingAddress}
                                onSave={existingUser ? handleAddressSaved : (newAddress) => {
                                    setNewAddresses(prev => [...prev, newAddress]);
                                    setShowAddressForm(false);
                                }}
                                onCancel={() => { setShowAddressForm(false); setEditingAddress(null); }}
                                provinces={provinces}
                                shippingCompanies={shippingCompanies}
                                isNewUserFlow={!existingUser}
                            />
                        )}
                    </div>
                </Modal>
            );
        };

        const UserManagement = ({ appData, fetchData }) => {
            const [users, setUsers] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingUser, setEditingUser] = useState(null);
            const [confirmState, setConfirmState] = useState({ isOpen: false, onConfirm: null, message: '' });
            const [searchTerm, setSearchTerm] = useState('');
            const [filterRoleId, setFilterRoleId] = useState(''); // New state for role filter
            
            // Map database values to display labels
            const prefixMap = {
                'Mr': 'جناب',
                'Mrs': 'بانو',
                'Company': 'شرکت'
            };
            
            const fetchUsers = async () => {
                setIsLoading(true);
                const { data, error } = await supabaseClient.from('profiles').select(`*, role(id, title), userlocation(location(*, city(*, province(title))))`).order('createdat', { ascending: false });
                if (error) console.error(error);
                else setUsers(data || []);
                setIsLoading(false);
            };

            useEffect(() => {
                fetchUsers();
            }, []);

            const refreshAllData = () => {
                fetchUsers();
                if (fetchData) fetchData();
            };
            
            const handleOpenModal = (user = null) => { setEditingUser(user); setIsModalOpen(true); };
            const handleCloseModal = () => { setIsModalOpen(false); setEditingUser(null); };
            
            const handleDeleteRequest = (userId, isDeleted) => {
                setConfirmState({ isOpen: true, message: `آیا از ${isDeleted ? 'فعال کردن' : 'غیرفعال کردن'} این کاربر اطمینان دارید؟`, onConfirm: () => executeSoftDelete(userId, isDeleted) });
            };
            
            const executeSoftDelete = async (userId, isDeleted) => {
                const { error } = await supabaseClient.from('profiles').update({ isdeleted: !isDeleted }).eq('id', userId);
                if (error) console.error('خطا: ', error.message);
                else fetchUsers();
                closeConfirmModal();
            };
            
            const closeConfirmModal = () => { setConfirmState({ isOpen: false, onConfirm: null, message: '' }); };
            
            const filteredUsers = useMemo(() => {
                const lowerCaseSearch = searchTerm.toLowerCase().trim();
                return users.filter(user => {
                    const matchesSearch = !lowerCaseSearch || 
                        (user.fullname && user.fullname.toLowerCase().includes(lowerCaseSearch)) ||
                        (user.mobile && user.mobile.includes(lowerCaseSearch));
                    
                    // Fix: Ensure both IDs are compared as strings to avoid type mismatch (number vs string)
                    const matchesRole = !filterRoleId || (user.role && String(user.role.id) === String(filterRoleId));
                    
                    return matchesSearch && matchesRole;
                });
            }, [users, searchTerm, filterRoleId]);
            
            return (
                <div className="animate-fadeIn">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-gray-900 dark:text-white">مدیریت کاربران</h1>
                            <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">لیست تمام کاربران و مدیریت دسترسی‌ها</p>
                        </div>
                        <button onClick={() => handleOpenModal()} className="w-full md:w-auto text-white bg-indigo-600 hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-indigo-600 dark:hover:bg-indigo-700 focus:outline-none dark:focus:ring-indigo-800 transition-colors flex items-center justify-center gap-2" disabled={isLoading}>
                            <i className="fa-solid fa-user-plus"></i> افزودن کاربر جدید
                        </button>
                    </div>
                    
                    <div className="flex flex-col md:flex-row gap-4 mb-6">
                        <div className="relative flex-grow">
                            <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                                <i className="fa-solid fa-search text-gray-400"></i>
                            </div>
                            <input
                                type="text"
                                placeholder="جستجو بر اساس نام یا شماره موبایل..."
                                className="block w-full p-4 pl-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500"
                                value={searchTerm}
                                onChange={e => setSearchTerm(e.target.value)}
                            />
                        </div>
                        <div className="w-full md:w-64">
                            <select
                                value={filterRoleId}
                                onChange={(e) => setFilterRoleId(e.target.value)}
                                className="block w-full p-4 text-sm text-gray-900 border border-gray-300 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-800 dark:border-gray-700 dark:placeholder-gray-400 dark:text-white dark:focus:ring-indigo-500 dark:focus:border-indigo-500"
                            >
                                <option value="">همه نقش‌ها</option>
                                {appData.roles.map(role => (
                                    <option key={role.id} value={role.id}>{role.title}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    {/* Desktop Table View */}
                    <div className="hidden md:block bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-right text-gray-500 dark:text-gray-400">
                                <thead className="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                                    <tr>
                                        <th className="px-6 py-3">نام کامل</th>
                                        <th className="px-6 py-3">نام کوچک</th>
                                        <th className="px-6 py-3">عنوان</th>
                                        <th className="px-6 py-3">شماره موبایل</th>
                                        <th className="px-6 py-3 hidden sm:table-cell">موقعیت</th>
                                        <th className="px-6 py-3">نقش</th>
                                        <th className="px-6 py-3">وضعیت</th>
                                        <th className="px-6 py-3">عملیات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {isLoading ? (
                                        <tr><td colSpan="8" className="text-center py-8"><div className="spinner mx-auto border-indigo-500"></div></td></tr>
                                    ) : filteredUsers.length === 0 ? (
                                        <tr><td colSpan="8" className="text-center py-8 text-gray-500">هیچ کاربری یافت نشد.</td></tr>
                                    ) : (
                                        filteredUsers.map(user => {
                                            const province = user.userlocation[0]?.location?.city?.province?.title;
                                            const city = user.userlocation[0]?.location?.city?.title;
                                            const locationText = province && city ? `${province}، ${city}` : '-';
                                            const firstName = user.firstname || '-';

                                            return (
                                                <tr key={user.id} className={`bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 ${user.isdeleted ? 'opacity-60' : ''}`}>
                                                    <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap dark:text-white flex items-center gap-2">
                                                        <div className="w-8 h-8 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold text-xs">
                                                            {user.fullname ? user.fullname.charAt(0) : '?'}
                                                        </div>
                                                        {user.fullname || '-'}
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <span className="text-gray-700 dark:text-gray-300 font-medium">
                                                            {firstName}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <span className="text-gray-700 dark:text-gray-300">
                                                            {prefixMap[user.prefix] || '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4 font-mono">{user.mobile || '-'}</td>
                                                    <td className="px-6 py-4 hidden sm:table-cell">{locationText}</td>
                                                    <td className="px-6 py-4">
                                                        <span className="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-indigo-900 dark:text-indigo-300">
                                                            {user.role?.title || 'Customer'}
                                                        </span>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center">
                                                            <div className={`h-2.5 w-2.5 rounded-full ml-2 ${user.isdeleted ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                                            {user.isdeleted ? 'غیرفعال' : 'فعال'}
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="flex gap-3">
                                                            <button onClick={() => handleOpenModal(user)} className="font-medium text-indigo-600 dark:text-indigo-500 hover:underline">ویرایش</button>
                                                            <button onClick={() => handleDeleteRequest(user.id, user.isdeleted)} className={`font-medium hover:underline ${user.isdeleted ? 'text-green-600 dark:text-green-500' : 'text-red-600 dark:text-red-500'}`}>
                                                                {user.isdeleted ? 'فعال‌سازی' : 'غیرفعال'}
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            )
                                        })
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    {/* Mobile Card View */}
                    <div className="md:hidden space-y-4">
                        {isLoading ? (
                            <div className="text-center py-8"><div className="spinner mx-auto border-indigo-500"></div></div>
                        ) : filteredUsers.length === 0 ? (
                            <div className="text-center py-8 text-gray-500 bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">هیچ کاربری یافت نشد.</div>
                        ) : (
                            filteredUsers.map(user => {
                                const province = user.userlocation[0]?.location?.city?.province?.title;
                                const city = user.userlocation[0]?.location?.city?.title;
                                const locationText = province && city ? `${province}، ${city}` : '-';
                                const firstName = user.firstname || '-';
                                const prefixLabel = prefixMap[user.prefix] || '-';

                                return (
                                    <div key={user.id} className={`bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-200 dark:border-gray-700 ${user.isdeleted ? 'opacity-75 grayscale' : ''}`}>
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="flex items-center gap-3">
                                                <div className="w-12 h-12 rounded-full bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center text-indigo-600 dark:text-indigo-300 font-bold text-lg">
                                                    {user.fullname ? user.fullname.charAt(0) : '?'}
                                                </div>
                                                <div>
                                                    <h3 className="font-bold text-gray-900 dark:text-white text-lg">{user.fullname || '-'}</h3>
                                                    <div className="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-400 mt-1">
                                                        {prefixLabel !== '-' && <span className="bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300">{prefixLabel}</span>}
                                                        <span>{firstName}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className={`px-2 py-1 rounded-full text-xs font-medium ${user.isdeleted ? 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400' : 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400'}`}>
                                                {user.isdeleted ? 'غیرفعال' : 'فعال'}
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-2 mb-4">
                                            <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                                                <i className="fa-solid fa-mobile-screen w-5 text-center text-gray-400"></i>
                                                <span className="font-mono">{user.mobile || '-'}</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                                                <i className="fa-solid fa-location-dot w-5 text-center text-gray-400"></i>
                                                <span>{locationText}</span>
                                            </div>
                                            <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
                                                <i className="fa-solid fa-user-tag w-5 text-center text-gray-400"></i>
                                                <span className="bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300 px-2 py-0.5 rounded text-xs">
                                                    {user.role?.title || 'Customer'}
                                                </span>
                                            </div>
                                        </div>

                                        <div className="flex gap-3 pt-3 border-t border-gray-100 dark:border-gray-700">
                                            <button onClick={() => handleOpenModal(user)} className="flex-1 bg-indigo-50 hover:bg-indigo-100 dark:bg-indigo-900/30 dark:hover:bg-indigo-900/50 text-indigo-700 dark:text-indigo-300 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                                <i className="fa-regular fa-pen-to-square"></i> ویرایش
                                            </button>
                                            <button onClick={() => handleDeleteRequest(user.id, user.isdeleted)} className={`flex-1 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2 ${user.isdeleted ? 'bg-green-50 hover:bg-green-100 dark:bg-green-900/30 dark:hover:bg-green-900/50 text-green-700 dark:text-green-300' : 'bg-red-50 hover:bg-red-100 dark:bg-red-900/30 dark:hover:bg-red-900/50 text-red-700 dark:text-red-300'}`}>
                                                <i className={`fa-solid ${user.isdeleted ? 'fa-check' : 'fa-ban'}`}></i> 
                                                {user.isdeleted ? 'فعال‌سازی' : 'غیرفعال'}
                                            </button>
                                        </div>
                                    </div>
                                )
                            })
                        )}
                    </div>

                    {isModalOpen && <UserForm isOpen={isModalOpen} onClose={handleCloseModal} onSave={refreshAllData} user={editingUser} appData={appData} />}
                    <ConfirmModal isOpen={confirmState.isOpen} onClose={closeConfirmModal} onConfirm={confirmState.onConfirm} title="تایید عملیات" message={confirmState.message} />
                </div>
            );
        };
        
        // ==================================================
        // Settings / Attributes Management Component
        // ==================================================
        const SettingsManagement = ({ appData, fetchData }) => {
            const [confirmState, setConfirmState] = useState({ isOpen: false, onConfirm: null, message: '' });
            const [isAssignModalOpen, setIsAssignModalOpen] = useState(false);
            const [selectedRole, setSelectedRole] = useState(null);

            const handleManageRoleAttributes = (role) => {
                setSelectedRole(role);
                setIsAssignModalOpen(true);
            };

            const AssignRoleLocationAttributesModal = ({ isOpen, onClose, role, allAttributes, onSave }) => {
                const [selectedAttributes, setSelectedAttributes] = useState(new Set());
                const [isLoading, setIsLoading] = useState(true);

                useEffect(() => {
                    if (isOpen && role) {
                        setIsLoading(true);
                        supabaseClient
                            .from('role_location_attribute')
                            .select('attribute_id')
                            .eq('role_id', role.id)
                            .then(({ data, error }) => {
                                if (error) console.error(error);
                                else {
                                    const initialSelected = new Set(data.map(item => item.attribute_id));
                                    setSelectedAttributes(initialSelected);
                                }
                                setIsLoading(false);
                            });
                    }
                }, [isOpen, role]);

                const handleToggle = (attributeId) => {
                    setSelectedAttributes(prev => {
                        const newSet = new Set(prev);
                        if (newSet.has(attributeId)) newSet.delete(attributeId);
                        else newSet.add(attributeId);
                        return newSet;
                    });
                };

                const handleSave = async () => {
                    setIsLoading(true);
                    await supabaseClient.from('role_location_attribute').delete().eq('role_id', role.id);
                    const toInsert = Array.from(selectedAttributes).map(attrId => ({
                        role_id: role.id,
                        attribute_id: attrId
                    }));
                    if (toInsert.length > 0) {
                        await supabaseClient.from('role_location_attribute').insert(toInsert);
                    }
                    onSave();
                    onClose();
                };

                return (
                    <Modal isOpen={isOpen} onClose={onClose} title={`مدیریت فیلدهای آدرس برای نقش: ${role?.title}`}>
                        {isLoading ? <div className="text-center py-4"><div className="spinner mx-auto border-indigo-500"></div></div> : (
                            <div className="space-y-2 max-h-96 overflow-y-auto p-2">
                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-3">ویژگی‌هایی که این نقش هنگام ثبت آدرس باید مشاهده کند را انتخاب کنید:</p>
                                {allAttributes.map(attr => (
                                    <label key={attr.id} className="flex items-center p-3 rounded-lg border border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition-colors">
                                        <input 
                                            type="checkbox" 
                                            className="ml-3 w-4 h-4 text-indigo-600 bg-gray-100 border-gray-300 rounded focus:ring-indigo-500 dark:focus:ring-indigo-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" 
                                            checked={selectedAttributes.has(attr.id)} 
                                            onChange={() => handleToggle(attr.id)} 
                                        />
                                        <span className="text-sm font-medium text-gray-900 dark:text-gray-300">{attr.title}</span>
                                        <span className="mr-auto text-xs text-gray-400 bg-gray-100 dark:bg-gray-600 px-2 py-1 rounded">{attr.data_type}</span>
                                    </label>
                                ))}
                            </div>
                        )}
                        <div className="flex justify-end gap-3 pt-4 mt-4 border-t border-gray-200 dark:border-gray-600">
                            <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600 dark:hover:bg-gray-600">انصراف</button>
                            <button onClick={handleSave} disabled={isLoading} className="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 focus:ring-4 focus:ring-indigo-300 dark:focus:ring-indigo-900">ذخیره تغییرات</button>
                        </div>
                    </Modal>
                );
            };

            return (
                <div className="animate-fadeIn">
                    <h1 className="text-2xl font-bold mb-2 text-gray-900 dark:text-white">تنظیمات سیستم</h1>
                    <p className="text-gray-500 dark:text-gray-400 mb-6">مدیریت تعاریف پایه و دسترسی‌های فرم‌ها</p>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <GenericManager
                            onSave={fetchData}
                            title="ویژگی‌های آدرس"
                            tableName="location_attribute_key"
                            items={appData.locationAttributes}
                            confirmModal={(config) => setConfirmState({...config, onConfirm: () => {config.onConfirm(); setConfirmState({isOpen: false})}})}
                        />
                        <GenericManager
                            onSave={fetchData}
                            title="نقش‌های کاربری"
                            tableName="role"
                            items={appData.roles}
                            confirmModal={(config) => setConfirmState({...config, onConfirm: () => {config.onConfirm(); setConfirmState({isOpen: false})}})}
                            onManageAttributes={handleManageRoleAttributes}
                            attributeLabel="فیلدهای آدرس"
                        />
                    </div>
                    <ConfirmModal isOpen={confirmState.isOpen} onClose={() => setConfirmState({isOpen: false})} onConfirm={confirmState.onConfirm} title="تایید عملیات" message={confirmState.message} />
                    {isAssignModalOpen && (
                        <AssignRoleLocationAttributesModal 
                            isOpen={isAssignModalOpen}
                            onClose={() => setIsAssignModalOpen(false)}
                            role={selectedRole}
                            allAttributes={appData.locationAttributes}
                            onSave={fetchData}
                        />
                    )}
                </div>
            );
        };
        
        // ==================================================
        // Main App Component
        // ==================================================
        const App = () => {
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light'); // Default to light for better visibility first
            const [currentPage, setCurrentPage] = useState('users');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [appData, setAppData] = useState({ roles: [], provinces: [], marketingChannels: [], shippingCompanies: [], locationAttributes: [] });
            const [isLoading, setIsLoading] = useState(true);

            const fetchAppData = useCallback(async () => {
                setIsLoading(true);
                try {
                    const [rolesRes, provinceRes, channelRes, shippingRes, locAttrRes] = await Promise.all([
                        supabaseClient.from('role').select('*').order('title'),
                        supabaseClient.from('province').select('*').order('title'),
                        supabaseClient.from('marketingchannel').select('*').order('title'),
                        supabaseClient.from('shippingcompany').select('*').order('title'),
                        supabaseClient.from('location_attribute_key').select('*').order('title')
                    ]);
                    
                    setAppData({
                        roles: rolesRes.data || [],
                        provinces: provinceRes.data || [],
                        marketingChannels: channelRes.data || [],
                        shippingCompanies: shippingRes.data || [],
                        locationAttributes: locAttrRes.data || []
                    });
                } catch (error) {
                    console.error("Initial data fetch error:", error);
                }
                setIsLoading(false);
            }, []);
            
            useEffect(() => {
                fetchAppData();
            }, [fetchAppData]);

            useEffect(() => {
                const root = window.document.documentElement;
                const isDark = theme === 'dark';
                root.classList.remove(isDark ? 'light' : 'dark');
                root.classList.add(theme);
                localStorage.setItem('theme', theme);
            }, [theme]);

            const toggleTheme = () => {
                setTheme(prevTheme => prevTheme === 'light' ? 'dark' : 'light');
            };

            const renderPage = () => {
                if(isLoading) {
                    return <div className="flex items-center justify-center h-full"><div className="spinner w-10 h-10 border-indigo-500"></div></div>
                }
                switch (currentPage) {
                    case 'users': return <UserManagement appData={appData} fetchData={fetchAppData} />;
                    case 'settings': return <SettingsManagement appData={appData} fetchData={fetchAppData} />;
                    default: return <UserManagement appData={appData} fetchData={fetchAppData} />;
                }
            };
            
            const NavItem = ({ page, icon, children }) => {
                const isActive = currentPage === page;
                return ( 
                    <li onClick={() => {setCurrentPage(page); setIsSidebarOpen(false);}} className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-all duration-200 ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'text-gray-600 dark:text-gray-300 hover:bg-indigo-50 dark:hover:bg-gray-700'}`}>
                        <i className={`fa-solid ${icon} w-5 text-center`}></i>
                        <span className="font-medium">{children}</span>
                    </li> 
                );
            };

            const Sidebar = () => (
                <aside className={`fixed lg:relative inset-y-0 right-0 z-50 w-64 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : 'translate-x-full'} lg:translate-x-0 flex flex-col shadow-xl lg:shadow-none`}>
                    <div className="h-16 flex items-center justify-center border-b border-gray-200 dark:border-gray-700">
                        <span className="text-xl font-black text-indigo-600 dark:text-indigo-400 flex items-center gap-2">
                            <i className="fa-solid fa-layer-group"></i>
                            Bazaario
                        </span>
                    </div>
                    <nav className="flex-1 p-4">
                        <ul className="space-y-2">
                            <NavItem page="users" icon="fa-users">مدیریت کاربران</NavItem>
                            <NavItem page="settings" icon="fa-sliders">تنظیمات فرم‌ها</NavItem>
                        </ul>
                    </nav>
                    <div className="p-4 border-t border-gray-200 dark:border-gray-700">
                        <button onClick={toggleTheme} className="w-full flex items-center justify-center gap-2 p-2 rounded-lg text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                           {theme === 'light' ? <><i className="fa-solid fa-moon"></i> حالت تاریک</> : <><i className="fa-solid fa-sun"></i> حالت روشن</>}
                        </button>
                    </div>
                </aside>
            );

            return (
                <div className="relative min-h-screen lg:flex bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 overflow-hidden">
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 lg:hidden backdrop-blur-sm" onClick={() => setIsSidebarOpen(false)}></div>}
                    <Sidebar />
                    <div className="flex-1 flex flex-col h-screen">
                        <header className="lg:hidden flex items-center justify-between h-16 px-4 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 shadow-sm z-30">
                            <span className="text-lg font-bold text-gray-900 dark:text-white">پنل مدیریت</span>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-600 dark:text-gray-200 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                                <i className="fa-solid fa-bars text-xl"></i>
                            </button>
                        </header>
                        <main className="flex-1 p-4 sm:p-6 lg:p-8 overflow-y-auto custom-scrollbar">
                            {renderPage()}
                        </main>
                    </div>
                </div>
            );
        };

        const container = document.getElementById('root');
        // Ensure ReactDOM is available
        const root = (window.ReactDOM || ReactDOM).createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>